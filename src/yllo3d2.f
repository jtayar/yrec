C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C    YLLO3D2
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
      SUBROUTINE YLLO3D2(DL,TL,X,OF,OLF,QODF,QOTF)
C DBG 5/94 opacity at different Z
      IMPLICIT REAL*8 (A-H,O-Z)
      IMPLICIT LOGICAL*4 (L)
      PARAMETER (NUMT=50)
      PARAMETER (NUMD=17)
      PARAMETER (NUMX=3)
      PARAMETER (NUMXT=NUMT*NUMX)
      PARAMETER (NUM4D=4*NUMD)
      COMMON /GLLOT2/GRIDT2(NUMT),GRIDX2(NUMX),GRHOT32(NUMD)
      COMMON /LLOT2/OPACITY2(NUMXT,NUMD),NUMXM2,NUMTM2
      COMMON /LLOT42/XENV42,ZENV42,CFORD42(NUMT,NUM4D),KIPM12
      COMMON /KIPMLL2/M12,M22,M32
      SAVE

      LONE=.FALSE.
C INDEPENDENT PARAMETER IN LIVERMORE OPACITY TABLE;
C T6 = LN(T/10E6)
      T6=TL-6.0D0
C RHOT3 = LN(RHO/(T/10E6)**3)
      RHOT3=DL-3.0D0*T6

      IF(DABS(XENV42-X).LE.1.0D-5)THEN
         M12=4
         LONE=.TRUE.
         GO TO 131
      ENDIF
      DO 130 IM1=1,NUMX
         IF(DABS(GRIDX2(IM1)-X).LE.1.0D-5)THEN
            M12=IM1
            LONE=.TRUE.
            GO TO 131
         ENDIF
 130  CONTINUE
      CALL FINDEX(GRIDX2,NUMX,X,M12)
      IF(M12.LT.0)M12=-M12
      IF(M12.LE.1.AND.RHOT3.GT.-1.0D0)M12=2
      IF(M12.GE.3)M12=2
      IF(M12.LE.0)STOP ' ERROR IN X2 GRID'
 131  CONTINUE
      CALL FINDEX(GRIDT2,NUMTM2,T6,M22)
      IF(M22.LT.0.AND.GRIDT2(NUMTM2).EQ.T6)M22=-M22
      IF(M22.LT.0)STOP ' T OUT OF TABLE '
      CALL YLLO2D2(T6,RHOT3,M12,M22,M32,O0,OL0,QOD0,QOT0)
      IF (LONE)THEN
C>>> USE ONLY ONE X TABLE
         OLF=OL0
         OF=O0
         QODI=QOD0
         QOTI=QOT0
      ELSE
C>>> LINEAR EXTRAPOLATION IN X
         CALL YLLO2D2(T6,RHOT3,M12+1,M22,M32,O1,OL1,QOD1,QOT1)
         GRDNT=(X-GRIDX2(M12))/(GRIDX2(M12+1)-GRIDX2(M12))
         OLF=(OL1-OL0)*GRDNT+OL0
         QODI=(QOD1-QOD0)*GRDNT+QOD0
         QOTI=(QOT1-QOT0)*GRDNT+QOT0
         OF=10.0D0**OLF
      ENDIF
C CONVERSION FROM THE DERIVATIVE WITH CONSTANT RHOT3 TO CONSTANT RHO
      QODF=QODI
      QOTF=QOTI-3.0D0*QODF

      RETURN
      END
